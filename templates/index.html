<!DOCTYPE html>
<html>
  <head>
    <title>Socratic AI</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

    <style>
      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #f5f5f5;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        background: #007aff;
        color: #fff;
        padding: 16px 20px;
        font-size: 20px;
        font-weight: 600;
      }

      #topBar {
        padding: 12px 20px;
        background: #fff;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }

      #topBar button,
      #topBar select {
        padding: 8px 14px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background: #fff;
        cursor: pointer;
        font-size: 14px;
      }

      #topBar button:hover {
        background: #f5f5f5;
      }

      #contactSection {
        padding: 10px 20px;
        background: #fff;
        border-bottom: 1px solid #e0e0e0;
      }

      #contactSection a {
        color: #5865f2;
        text-decoration: none;
        font-weight: 600;
      }

      #contactSection a:hover {
        text-decoration: underline;
      }

      #chatContainer {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: none;
        flex-direction: column;
        gap: 12px;
        background: #f5f5f5;
      }

      .message {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        line-height: 1.6;
        word-wrap: break-word;
        background: #e9ecef;
        color: #212529;
        align-self: flex-start;
      }

      .userMsg {
        background: #007aff;
        color: #fff;
        align-self: flex-end;
        margin-left: auto;
        border-bottom-right-radius: 4px;
      }

      .aiMsg {
        border-bottom-left-radius: 4px;
      }

      #inputContainer {
        padding: 16px 20px;
        background: #fff;
        border-top: 1px solid #e0e0e0;
        display: none;
        gap: 10px;
        align-items: flex-end;
      }

      #userInput {
        flex: 1;
        padding: 12px 15px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 12px;
        outline: none;
        resize: vertical;
        min-height: 44px;
        max-height: 150px;
      }

      #sendBtn {
        padding: 12px 24px;
        background: #007aff;
        color: #fff;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-size: 16px;
      }

      #sendBtn:hover {
        background: #0051d5;
      }

      #disclaimer {
        display: none;
        padding: 6px 20px;
        font-size: 12px;
        color: #666;
        text-align: center;
        background: #fff;
        border-top: 1px solid #e0e0e0;
      }

      .container-box {
        max-width: 720px;
        margin: 40px auto;
        background: #fff;
        padding: 24px;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
      }

      .auth-box {
        max-width: 400px;
        margin: 40px auto;
        background: #fff;
        padding: 24px;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
      }

      .row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .btn-primary {
        background: #007aff;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 10px 14px;
        cursor: pointer;
      }

      .btn-ghost {
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 10px 14px;
        cursor: pointer;
      }

      .error {
        color: #b00020;
        font-size: 13px;
        margin-top: 8px;
      }

      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }

      .modal-content {
        width: 100%;
        max-width: 420px;
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
      }

      .modal-content input {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
      }
    </style>
  </head>

  <body>
    <header>Socratic AI</header>

    <div id="topBar">
      <button onclick="startNewConversation()">New Conversation</button>
      <select id="subjectSelect" onchange="setSubject(this.value)">
        <option value="">Select Subject</option>
        <option value="Biology">Biology</option>
        <option value="Physics">Physics</option>
        <option value="Math">Math</option>
        <option value="Chemistry">Chemistry</option>
      </select>
      <button onclick="showIntro()">How to use</button>

      <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
        <button id="joinClassroomBtn" style="display:none;" onclick="openJoinModal()">Join classroom</button>
        <button id="settingsBtn" style="display:none;" onclick="openSettings()">Settings</button>
        <span id="userBadge" style="display:none; font-size:13px; color:#666;"></span>
        <button id="logoutBtn" style="display:none;" onclick="logout()">Logout</button>
      </div>
    </div>

    <div id="contactSection">
      <div style="display:flex; align-items:center; gap:10px;">
        <span style="color:#444;">Community:</span>
        <a href="https://discord.gg/Bv6qQTk25X" target="_blank" rel="noopener noreferrer">Join our Discord</a>
      </div>
    </div>

    <div id="introContainer" style="padding:24px; display:block;">
      <div class="container-box">
        <h2>Welcome to Socratic AI</h2>
        <p style="margin:16px 0;">
          Create an account or log in. Then click “Join classroom” to enter a class with a code.
        </p>
        <div class="row">
          <button class="btn-primary" onclick="openSignupModal()">Create account</button>
          <button class="btn-ghost" onclick="showLogin()">Login</button>
        </div>
      </div>
    </div>

    <!-- Login -->
    <div id="authContainer" style="padding:24px; display:none;">
      <div class="auth-box">
        <h3 style="margin-top:0;">Login</h3>
        <input id="username" placeholder="Username" />
        <input id="password" type="password" placeholder="Password" />
        <button class="btn-primary" onclick="login()">Login</button>
        <div id="loginError" class="error" style="display:none;"></div>
      </div>
    </div>

    <!-- Chat UI -->
    <div id="chatContainer"></div>
    <div id="inputContainer">
      <textarea id="userInput" placeholder="Type your message..."></textarea>
      <button id="sendBtn">Send</button>
    </div>
    <div id="disclaimer">Socratic AI can make mistakes. Check important info.</div>

    <!-- Modals -->
    <div id="settingsModal" class="modal">
      <div class="modal-content">
        <h3 style="margin-top:0;">Change Password</h3>
        <input id="currentPw" type="password" placeholder="Current password" />
        <input id="newPw" type="password" placeholder="New password (min 6 chars)" />
        <div id="settingsError" class="error" style="display:none;"></div>
        <div class="row">
          <button class="btn-primary" onclick="savePassword()">Save</button>
          <button class="btn-ghost" onclick="closeSettings()">Cancel</button>
        </div>
      </div>
    </div>

    <div id="signupModal" class="modal">
      <div class="modal-content">
        <h3 style="margin-top:0;">Create Account</h3>
        <input id="suUsername" placeholder="Username" />
        <input id="suPassword" type="password" placeholder="Password (min 6 chars)" />
        <input id="suPassword2" type="password" placeholder="Confirm password" />
        <div id="signupError" class="error" style="display:none;"></div>
        <div class="row">
          <button class="btn-primary" onclick="signup()">Create</button>
          <button class="btn-ghost" onclick="closeSignupModal()">Cancel</button>
        </div>
      </div>
    </div>

    <div id="joinClassroomModal" class="modal">
      <div class="modal-content">
        <h3 style="margin-top:0;">Join Classroom</h3>
        <input id="joinCodeModal" placeholder="Enter class code (e.g., ABC123)" />
        <div id="joinClassroomError" class="error" style="display:none;"></div>
        <div class="row">
          <button class="btn-primary" onclick="joinClassroom()">Join</button>
          <button class="btn-ghost" onclick="closeJoinModal()">Cancel</button>
        </div>
      </div>
    </div>

    <script>
    // Supabase configuration
    const SUPABASE_URL = 'https://ssowfoqwoyoplavkgkcc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzb3dmb3F3b3lvcGxhdmtna2NjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MDM3NzQsImV4cCI6MjA3NjE3OTc3NH0.RRtcoh61Gjv16SWEavP9_I5cih0fyyRJSKXA0y4NBNk';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM elements
    const chatContainer = document.getElementById('chatContainer');
    const inputContainer = document.getElementById('inputContainer');
    const disclaimer = document.getElementById('disclaimer');
    const userBadge = document.getElementById('userBadge');
    const settingsBtn = document.getElementById('settingsBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const joinClassroomBtn = document.getElementById('joinClassroomBtn');
    const input = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    let currentStudent = null;
    let currentClassroom = null;

    // Utility: Hash passwords using SHA-256
    async function hashPassword(password) {
      const enc = new TextEncoder().encode(password);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    // UI state toggle
    function setSignedInUI(signedIn) {
      userBadge.style.display = signedIn ? 'inline' : 'none';
      settingsBtn.style.display = signedIn ? 'inline-block' : 'none';
      logoutBtn.style.display = signedIn ? 'inline-block' : 'none';
      joinClassroomBtn.style.display = signedIn ? 'inline-block' : 'none';
      chatContainer.style.display = signedIn ? 'flex' : 'none';
      inputContainer.style.display = signedIn ? 'flex' : 'none';
      disclaimer.style.display = signedIn ? 'block' : 'none';
    }

    // Navigation
    function showIntro() {
      chatContainer.style.display = 'none';
      document.getElementById('authContainer').style.display = 'none';
      document.getElementById('introContainer').style.display = 'block';
      inputContainer.style.display = 'none';
      disclaimer.style.display = 'none';
    }

    function showLogin() {
      document.getElementById('introContainer').style.display = 'none';
      document.getElementById('authContainer').style.display = 'block';
    }

    // Modals
    function openSettings() {
      const modal = document.getElementById('settingsModal');
      document.getElementById('settingsError').style.display = 'none';
      document.getElementById('currentPw').value = '';
      document.getElementById('newPw').value = '';
      modal.style.display = 'flex';
    }

    function closeSettings() {
      document.getElementById('settingsModal').style.display = 'none';
    }

    function openSignupModal() {
      const modal = document.getElementById('signupModal');
      document.getElementById('signupError').style.display = 'none';
      document.getElementById('suUsername').value = '';
      document.getElementById('suPassword').value = '';
      document.getElementById('suPassword2').value = '';
      modal.style.display = 'flex';
    }

    function closeSignupModal() {
      document.getElementById('signupModal').style.display = 'none';
    }

    function openJoinModal() {
      const modal = document.getElementById('joinClassroomModal');
      document.getElementById('joinClassroomError').style.display = 'none';
      document.getElementById('joinCodeModal').value = '';
      modal.style.display = 'flex';
    }

    function closeJoinModal() {
      document.getElementById('joinClassroomModal').style.display = 'none';
    }

    // Account management
    async function signup() {
      const u = document.getElementById('suUsername').value.trim();
      const p1 = document.getElementById('suPassword').value;
      const p2 = document.getElementById('suPassword2').value;
      const err = document.getElementById('signupError');
      err.style.display = 'none';

      if (!u || !p1 || !p2) return showError(err, 'All fields are required');
      if (p1.length < 6) return showError(err, 'Password must be at least 6 characters');
      if (p1 !== p2) return showError(err, 'Passwords do not match');

      try {
        const hash = await hashPassword(p1);
        const { data: existing } = await supabase
          .from('students')
          .select('id')
          .eq('username', u)
          .maybeSingle();

        if (existing) return showError(err, 'Username already exists');

        const { data: created, error } = await supabase
          .from('students')
          .insert({ username: u, password_hash: hash })
          .select()
          .single();

        if (error || !created) throw error || new Error('Create failed');

        currentStudent = created;
        localStorage.setItem('currentStudent', JSON.stringify(created));
        userBadge.textContent = `Signed in as ${created.username}`;
        closeSignupModal();
        setSignedInUI(true);
        document.getElementById('authContainer').style.display = 'none';
        document.getElementById('introContainer').style.display = 'none';
      } catch (e) {
        showError(err, e?.message || 'Could not create account');
      }
    }

    async function login() {
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value;
      const err = document.getElementById('loginError');
      err.style.display = 'none';

      if (!u || !p) return showError(err, 'Username and password required');

      const hash = await hashPassword(p);
      const { data: student, error } = await supabase
        .from('students')
        .select('*')
        .eq('username', u)
        .maybeSingle();

      if (error || !student || student.password_hash !== hash)
        return showError(err, 'Invalid credentials');

      currentStudent = student;
      localStorage.setItem('currentStudent', JSON.stringify(student));
      userBadge.textContent = `Signed in as ${student.username}`;
      document.getElementById('authContainer').style.display = 'none';
      document.getElementById('introContainer').style.display = 'none';
      setSignedInUI(true);
    }

    async function savePassword() {
      const currentPw = document.getElementById('currentPw').value;
      const newPw = document.getElementById('newPw').value;
      const err = document.getElementById('settingsError');
      err.style.display = 'none';

      if (!currentStudent) return showError(err, 'Not signed in');
      if (!currentPw || !newPw) return showError(err, 'Both fields are required');
      if (newPw.length < 6) return showError(err, 'New password must be at least 6 characters');

      const currentHash = await hashPassword(currentPw);
      if (currentStudent.password_hash !== currentHash)
        return showError(err, 'Current password is incorrect');

      const newHash = await hashPassword(newPw);
      const { error } = await supabase
        .from('students')
        .update({ password_hash: newHash })
        .eq('id', currentStudent.id);

      if (error) return showError(err, 'Could not update password');

      currentStudent.password_hash = newHash;
      localStorage.setItem('currentStudent', JSON.stringify(currentStudent));
      alert('Password updated successfully!');
      closeSettings();
    }

    async function joinClassroom() {
      const code = document.getElementById('joinCodeModal').value.trim().toUpperCase();
      const err = document.getElementById('joinClassroomError');
      err.style.display = 'none';

      if (!currentStudent) return showError(err, 'Please login first');
      if (!code) return showError(err, 'Enter a class code');

      const { data: classroom, error } = await supabase
        .from('classrooms')
        .select('*')
        .eq('join_code', code)
        .maybeSingle();

      if (error || !classroom) return showError(err, 'Invalid class code');

      const { error: enrollErr } = await supabase
        .from('enrollments')
        .insert({ classroom_id: classroom.id, student_id: currentStudent.id });

      if (enrollErr && !String(enrollErr.message).includes('duplicate'))
        return showError(err, enrollErr.message || 'Could not join classroom');

      currentClassroom = classroom;
      localStorage.setItem('currentClassroom', JSON.stringify(classroom));
      alert(`Joined classroom: ${classroom.name}`);
      closeJoinModal();
      setSignedInUI(true);
    }

    async function logout() {
      currentStudent = null;
      currentClassroom = null;
      localStorage.removeItem('currentStudent');
      localStorage.removeItem('currentClassroom');
      setSignedInUI(false);
      showIntro();
      chatContainer.innerHTML = '';
      await fetch('/api/clear_session', { method: 'POST' });
    }

    // Session restore
    (function restoreSession() {
      const s = localStorage.getItem('currentStudent');
      const c = localStorage.getItem('currentClassroom');
      if (s) {
        currentStudent = JSON.parse(s);
        userBadge.textContent = `Signed in as ${currentStudent.username}`;
        setSignedInUI(true);
      }
      if (c) currentClassroom = JSON.parse(c);
    })();

    // Chat functions
    function addMessage(text, sender) {
      const msgDiv = document.createElement('div');
      msgDiv.className = `message ${sender}`;
      try {
        msgDiv.innerHTML = marked.parse(text || '');
      } catch {
        msgDiv.textContent = text || '';
      }
      chatContainer.appendChild(msgDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function sendMessage() {
      const message = input.value.trim();
      if (!message) return;
      if (!currentStudent) return alert('Please login first');
      if (!currentClassroom) return alert('Join a classroom to start');

      addMessage(message, 'userMsg');
      input.value = '';

      await supabase.from('messages').insert({
        classroom_id: currentClassroom.id,
        student_id: currentStudent.id,
        role: 'user',
        subject: document.getElementById('subjectSelect').value,
        content: message
      });

      const resp = await fetch('/api/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message })
      });
      const data = await resp.json();

      addMessage(data.answer, 'aiMsg');
      await supabase.from('messages').insert({
        classroom_id: currentClassroom.id,
        student_id: currentStudent.id,
        role: 'ai',
        subject: document.getElementById('subjectSelect').value,
        content: data.answer
      });
    }

    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Conversation and subject handling
    function startNewConversation() {
      chatContainer.innerHTML = '';
      document.getElementById('subjectSelect').value = '';
      inputContainer.style.display = currentStudent ? 'flex' : 'none';
      disclaimer.style.display = currentStudent ? 'block' : 'none';
      fetch('/api/clear_session', { method: 'POST' });
    }

    async function setSubject(subject) {
      if (!subject) return;
      chatContainer.innerHTML = '';
      inputContainer.style.display = currentStudent ? 'flex' : 'none';
      disclaimer.style.display = currentStudent ? 'block' : 'none';
      await fetch('/api/set_subject', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ subject })
      });
    }

    // Utility for displaying errors
    function showError(element, msg) {
      element.textContent = msg;
      element.style.display = 'block';
    }
    </script>
  </body>
</html>
